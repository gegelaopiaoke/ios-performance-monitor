# 内存泄漏检测功能使用说明

## 🧠 功能概述

iOS性能监控工具现已集成智能内存泄漏检测功能，能够实时分析应用内存使用趋势，自动检测潜在的内存泄漏问题，并提供优化建议。

## ✨ 主要特性

### 1. 智能检测算法
- **线性回归分析**：使用数学模型分析内存增长趋势
- **多维度评估**：综合考虑增长率、增长量、时间跨度等因素
- **动态阈值**：根据应用类型和使用场景自动调整检测敏感度

### 2. 实时提醒系统
- **分级提醒**：根据泄漏严重程度显示不同颜色和样式
  - 🟢 **轻微**：黄色提醒，建议持续观察
  - 🟡 **警告**：橙色提醒，建议检查内存使用
  - 🔴 **严重**：红色提醒，需要立即处理
- **智能冷却**：避免频繁提醒，提供更好的用户体验
- **音效提醒**：支持浏览器音效通知（可选）

### 3. 详细分析报告
- **当前内存使用量**：实时显示应用内存占用
- **增长率分析**：MB/分钟的内存增长速度
- **累计增长量**：检测时间窗口内的总内存增长
- **检测时长**：分析数据的时间跨度
- **优化建议**：针对性的代码优化建议

### 4. 配置管理
- **泄漏阈值**：设置触发检测的最小内存增长量（默认50MB）
- **时间窗口**：检测分析的时间范围（默认5分钟）
- **增长率阈值**：触发提醒的最小增长率（默认0.5MB/分钟）
- **提醒冷却时间**：两次提醒之间的最小间隔（默认1分钟）

### 5. 事件日志记录
- **自动记录**：所有内存泄漏事件自动保存到日志文件
- **详细信息**：包含时间戳、应用信息、检测数据等
- **历史查询**：支持查看最近的泄漏事件历史
- **日志管理**：支持清空和导出日志功能

## 🚀 使用方法

### 1. 启动监控
```bash
# 启动iOS性能监控工具
cd /Users/apple/Downloads/ios性能
python ios/web_visualizer.py
```

### 2. 配置检测参数
1. 在Web界面中找到"🧠 内存泄漏检测设置"面板
2. 根据应用特性调整以下参数：
   - **泄漏阈值**：游戏应用建议100MB，普通应用50MB
   - **时间窗口**：快速测试300秒，长期监控600秒
   - **增长率阈值**：敏感检测0.3MB/分钟，标准检测0.5MB/分钟
   - **提醒冷却时间**：开发调试30秒，生产环境60秒

### 3. 开始监控
1. 选择目标iOS设备
2. 选择要监控的应用
3. 点击"开始监控"按钮
4. 观察内存使用趋势和泄漏提醒

### 4. 分析结果
- **实时图表**：观察内存使用曲线的变化趋势
- **泄漏提醒**：当检测到泄漏时会弹出详细提醒窗口
- **状态指示器**：查看右上角的检测状态（监控中/检测到泄漏/正常）

## 📊 检测算法详解

### 线性回归分析
系统使用最小二乘法计算内存使用的线性回归斜率：

```
斜率 = (n×Σ(xy) - Σ(x)×Σ(y)) / (n×Σ(x²) - (Σ(x))²)
增长率 = 斜率 × (样本数 / 时间跨度分钟数)
```

### 泄漏判定条件
同时满足以下条件才会触发泄漏提醒：
1. **增长率超阈值**：`增长率 > growth_rate_threshold`
2. **增长量超阈值**：`内存增长量 > leak_threshold`
3. **当前内存高于基线**：`当前内存 > 最小内存 + leak_threshold`

### 严重程度分级
- **严重 (Critical)**：增长率 > 2.0 MB/分钟 或 增长量 > 200MB
- **警告 (Warning)**：增长率 > 1.0 MB/分钟 或 增长量 > 100MB
- **轻微 (Minor)**：其他情况

## 🛠️ 优化建议

### 根据应用类型调整参数

#### 游戏应用
```
泄漏阈值: 100-200MB
时间窗口: 600秒
增长率阈值: 1.0MB/分钟
```
**原因**：游戏应用内存使用较大，需要更宽松的阈值

#### 社交/媒体应用
```
泄漏阈值: 50-80MB
时间窗口: 300秒
增长率阈值: 0.5MB/分钟
```
**原因**：此类应用容易出现图片/视频缓存泄漏

#### 工具/效率应用
```
泄漏阈值: 30-50MB
时间窗口: 300秒
增长率阈值: 0.3MB/分钟
```
**原因**：工具应用内存使用应该相对稳定

### 开发阶段建议
- **开发调试**：使用较低阈值，快速发现问题
- **集成测试**：使用标准阈值，验证修复效果
- **性能测试**：使用较高阈值，关注严重泄漏

## 📝 日志文件格式

日志文件位置：`logs/memory_leak_events.log`

每行为一个JSON对象，包含以下字段：
```json
{
    "timestamp": "2024-01-15 14:30:25",
    "event_type": "memory_leak_detected",
    "severity": "warning",
    "current_memory": 156.8,
    "growth_rate": 1.2,
    "memory_increase": 45.3,
    "time_span": 4.5,
    "samples_count": 12,
    "recommendations": ["建议检查是否存在未释放的对象"],
    "app_info": {
        "pid": 1234,
        "name": "MyApp",
        "bundle_id": "com.example.myapp"
    }
}
```

## 🧪 测试验证

运行测试脚本验证功能：
```bash
python test_memory_leak_detection.py
```

测试包含：
- 正常内存使用场景
- 轻微内存泄漏场景
- 严重内存泄漏场景
- 不同应用类型场景

## ❓ 常见问题

### Q: 为什么没有检测到明显的内存泄漏？
A: 检查以下设置：
1. 确保样本数量足够（至少10个）
2. 检查时间窗口设置是否合理
3. 验证阈值设置是否过高

### Q: 提醒太频繁怎么办？
A: 调整以下参数：
1. 增加提醒冷却时间
2. 提高增长率阈值
3. 增加泄漏阈值

### Q: 如何针对特定应用优化检测？
A: 根据应用特性调整：
1. 游戏应用：提高所有阈值
2. 媒体应用：重点关注增长率
3. 工具应用：使用较严格的阈值

### Q: 日志文件太大怎么处理？
A: 可以：
1. 定期清空日志文件
2. 实现日志轮转机制
3. 只保留最近的重要事件

## 🔧 高级配置

### 自定义检测算法
如需修改检测算法，编辑 `ios/web_visualizer.py` 中的 `MemoryLeakDetector` 类。

### 集成外部监控
可以通过Socket.IO事件将泄漏检测结果发送到外部监控系统：
```javascript
socket.on('memory_leak_alert', function(data) {
    // 发送到外部监控系统
    sendToMonitoringSystem(data);
});
```

### 批量测试
创建自动化测试脚本，模拟不同的内存使用模式，验证检测算法的准确性。

---

**开发者**: 范博洲  
**版本**: 1.0.0  
**更新日期**: 2024年10月16日
