// AndroidÊÄßËÉΩÁõëÊéßJavaScript
// Socket.IOËøûÊé•
const socket = io();

// ÂÖ®Â±ÄÂèòÈáè
let isMonitoring = false;
let cpuChart, memoryChart, fpsChart, threadsChart, diskReadsChart, diskWritesChart;
let allTimeLabels = []; // Â≠òÂÇ®ÊâÄÊúâÊó∂Èó¥Ê†áÁ≠æ
let allCpuData = []; // Â≠òÂÇ®ÊâÄÊúâCPUÊï∞ÊçÆ
let allMemoryData = []; // Â≠òÂÇ®ÊâÄÊúâÂÜÖÂ≠òÊï∞ÊçÆ
let allFpsData = []; // Â≠òÂÇ®ÊâÄÊúâFPSÊï∞ÊçÆ
let allThreadsData = []; // Â≠òÂÇ®ÊâÄÊúâÁ∫øÁ®ãÊï∞ÊçÆ
let allDiskReadsData = []; // Â≠òÂÇ®ÊâÄÊúâÁ£ÅÁõòËØªÂèñÊï∞ÊçÆ
let allDiskWritesData = []; // Â≠òÂÇ®ÊâÄÊúâÁ£ÅÁõòÂÜôÂÖ•Êï∞ÊçÆ
let allApps = []; // Â≠òÂÇ®ÂÆåÊï¥Â∫îÁî®ÂàóË°®Áî®‰∫éÊêúÁ¥¢

// ÊÄßËÉΩÁªüËÆ°Êï∞ÊçÆ
let performanceStats = {
    cpu: { current: 0, avg: 0, max: 0, sum: 0, count: 0 },
    memory: { current: 0, avg: 0, max: 0, sum: 0, count: 0 },
    fps: { current: 0, avg: 0, min: Infinity, sum: 0, count: 0 },
    threads: { current: 0, avg: 0, max: 0, sum: 0, count: 0 },
    disk_reads: { current: 0, avg: 0, max: 0, sum: 0, count: 0 },
    disk_writes: { current: 0, avg: 0, max: 0, sum: 0, count: 0 }
};

// ÊãñÊãΩÂäüËÉΩ
function initDragAndDrop() {
    const container = document.querySelector('.container');
    if (!container) {
        console.warn('ÂÆπÂô®ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåË∑≥ËøáÊãñÊãΩÂàùÂßãÂåñ');
        return;
    }
    
    const panels = document.querySelectorAll('.controls, .chart-container, .statistics-panel, .thread-distribution');
    if (!panels || panels.length === 0) {
        console.warn('Èù¢ÊùøÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåË∑≥ËøáÊãñÊãΩÂàùÂßãÂåñ');
        return;
    }
    
    panels.forEach(panel => {
        // üîí ÂÖ≥ÈîÆ‰øÆÊîπ1ÔºöÁ¶ÅÊ≠¢ÁªüËÆ°Èù¢ÊùøË¢´ÊãñÊãΩÔºå‰øùËØÅÂÆÉÂõ∫ÂÆöÂú®ÂõæË°®‰∏äÊñπ
        if (panel.id === 'statisticsPanel') {
            panel.setAttribute('draggable', 'false');
            panel.style.cursor = 'default';
            return; // Ë∑≥ËøáÁªüËÆ°Èù¢ÊùøÔºå‰∏çÊ∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
        }
        
        panel.addEventListener('dragstart', handleDragStart);
        panel.addEventListener('dragend', handleDragEnd);
    });
    
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('drop', handleDrop);
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.id);
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    const draggedId = e.dataTransfer.getData('text/plain');
    const draggedElement = document.getElementById(draggedId);
    const afterElement = getDragAfterElement(e.target.closest('.container'), e.clientY);
    
    if (afterElement == null) {
        e.target.closest('.container').appendChild(draggedElement);
    } else {
        e.target.closest('.container').insertBefore(draggedElement, afterElement);
    }
    
    savePanelOrder();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.controls:not(.dragging), .chart-container:not(.dragging), .statistics-panel:not(.dragging), .thread-distribution:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function savePanelOrder() {
    const panels = document.querySelectorAll('.controls, .chart-container, .statistics-panel, .thread-distribution');
    const order = [];
    
    panels.forEach(panel => {
        // üîí ÂÖ≥ÈîÆ‰øÆÊîπ2ÔºöÊéíÈô§ÁªüËÆ°Èù¢ÊùøÔºå‰∏ç‰øùÂ≠òÂÆÉÁöÑ‰ΩçÁΩÆ
        if (panel.id && panel.id !== 'statisticsPanel') {
            order.push(panel.id);
        }
    });
    
    localStorage.setItem('androidPanelOrder', JSON.stringify(order));
    console.log('Â∑≤‰øùÂ≠òÈù¢ÊùøÈ°∫Â∫èÔºàÊéíÈô§ÁªüËÆ°Èù¢ÊùøÔºâ:', order);
}

function restorePanelOrder() {
    const savedOrder = localStorage.getItem('androidPanelOrder');
    if (!savedOrder) return;
    
    try {
        const order = JSON.parse(savedOrder);
        const container = document.querySelector('.container');
        
        if (!container) {
            console.warn('ÂÆπÂô®ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÊó†Ê≥ïÊÅ¢Â§çÈù¢ÊùøÈ°∫Â∫è');
            return;
        }
        
        // ÊâæÂà∞ÊâÄÊúâÈù¢ÊùøÔºàÊéíÈô§ÁªüËÆ°Èù¢ÊùøÔºâ
        const panels = {};
        document.querySelectorAll('.controls, .chart-container, .statistics-panel, .thread-distribution').forEach(panel => {
            if (panel.id && panel.id !== 'statisticsPanel') {
                // üîí ÂÖ≥ÈîÆ‰øÆÊîπ3ÔºöÊéíÈô§ÁªüËÆ°Èù¢ÊùøÔºå‰øùËØÅÂÆÉ‰∏çË¢´ÁßªÂä®
                panels[panel.id] = panel;
            }
        });
        
        // Êåâ‰øùÂ≠òÁöÑÈ°∫Â∫èÈáçÊñ∞ÊéíÂàóÔºà‰∏çÂåÖÊã¨ÁªüËÆ°Èù¢ÊùøÔºâ
        order.forEach(id => {
            if (panels[id]) {
                container.appendChild(panels[id]);
            }
        });
        
        console.log('Â∑≤ÊÅ¢Â§çÈù¢ÊùøÈ°∫Â∫èÔºàÁªüËÆ°Èù¢Êùø‰øùÊåÅÂõ∫ÂÆö‰ΩçÁΩÆÔºâ');
    } catch (error) {
        console.log('ÊÅ¢Â§çÈù¢ÊùøÈ°∫Â∫èÂ§±Ë¥•:', error);
    }
}

// ÂõæË°®ÈÖçÁΩÆ
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false
        }
    },
    scales: {
        x: {
            display: true,
            title: {
                display: true,
                text: 'Êó∂Èó¥'
            }
        },
        y: {
            display: true,
            beginAtZero: true
        }
    },
    elements: {
        line: {
            tension: 0.4
        },
        point: {
            radius: 3
        }
    }
};

// ÂàùÂßãÂåñÂõæË°®
function initCharts() {
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU‰ΩøÁî®Áéá (%)',
                data: [],
                borderColor: '#ff3b30',
                backgroundColor: 'rgba(255, 59, 48, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'CPU‰ΩøÁî®Áéá (%)'
                    }
                }
            }
        }
    });

    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'ÂÜÖÂ≠ò‰ΩøÁî® (MB)',
                data: [],
                borderColor: '#007aff',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'ÂÜÖÂ≠ò‰ΩøÁî® (MB)'
                    }
                }
            }
        }
    });

    const fpsCtx = document.getElementById('fpsChart').getContext('2d');
    fpsChart = new Chart(fpsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'FPS',
                data: [],
                borderColor: '#34c759',
                backgroundColor: 'rgba(52, 199, 89, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    min: 0,
                    max: 60,
                    title: {
                        display: true,
                        text: 'FPS'
                    }
                }
            }
        }
    });

    const threadsCtx = document.getElementById('threadsChart').getContext('2d');
    threadsChart = new Chart(threadsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Á∫øÁ®ãÊï∞',
                data: [],
                borderColor: '#ff9500',
                backgroundColor: 'rgba(255, 149, 0, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Á∫øÁ®ãÊï∞'
                    }
                }
            }
        }
    });

    const diskReadsCtx = document.getElementById('diskReadsChart').getContext('2d');
    diskReadsChart = new Chart(diskReadsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Á£ÅÁõòËØªÂèñ (MB)',
                data: [],
                borderColor: '#af52de',
                backgroundColor: 'rgba(175, 82, 222, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Á£ÅÁõòËØªÂèñ (MB)'
                    }
                }
            }
        }
    });

    const diskWritesCtx = document.getElementById('diskWritesChart').getContext('2d');
    diskWritesChart = new Chart(diskWritesCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Á£ÅÁõòÂÜôÂÖ• (MB)',
                data: [],
                borderColor: '#ff2d92',
                backgroundColor: 'rgba(255, 45, 146, 0.1)',
                fill: true
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Á£ÅÁõòÂÜôÂÖ• (MB)'
                    }
                }
            }
        }
    });
}

// ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
function showStatus(message, type) {
    const statusElement = document.getElementById('status');
    statusElement.textContent = message;
    statusElement.className = `status ${type}`;
    statusElement.classList.remove('hidden');
    
    setTimeout(() => {
        statusElement.classList.add('hidden');
    }, 5000);
}

// Ê∑ªÂä†Êï∞ÊçÆÂà∞ÂõæË°®
function addDataToChart(chart, label, data) {
    // Á°Æ‰øùÊï∞ÊçÆÊòØÊï∞Â≠óÁ±ªÂûã
    const numericData = typeof data === 'number' ? data : parseFloat(data) || 0;
    
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(numericData);
    
    // ‰øùÊåÅÂõæË°®Êï∞ÊçÆÈáèÂú®ÂêàÁêÜËåÉÂõ¥
    if (chart.data.labels.length > 50) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    
    chart.update('none');
}

// ÂºÄÂßãÁõëÊéß
function startMonitoring() {
    const deviceId = document.getElementById('deviceSelect').value;
    const packageName = document.getElementById('packageSelect').value;
    
    if (!deviceId) {
        showStatus('ËØ∑ÂÖàÈÄâÊã©ËÆæÂ§á', 'error');
        return;
    }
    
    if (!packageName) {
        showStatus('ËØ∑ÂÖàÈÄâÊã©Â∫îÁî®', 'error');
        return;
    }
    
    socket.emit('start_monitoring', {
        device_id: deviceId,
        package_name: packageName
    });
}

// ÂÅúÊ≠¢ÁõëÊéß
function stopMonitoring() {
    socket.emit('stop_monitoring');
}

// Âà∑Êñ∞ËÆæÂ§áÂàóË°®
function refreshDevices() {
    showStatus('Ê≠£Âú®Âà∑Êñ∞ËÆæÂ§áÂàóË°®...', 'info');
    socket.emit('get_devices');
}

// ËÆæÂ§áÈÄâÊã©ÂèòÊõ¥Êó∂Ëá™Âä®Ëé∑ÂèñÂ∫îÁî®ÂàóË°®
function onDeviceChanged() {
    const deviceId = document.getElementById('deviceSelect').value;
    if (deviceId) {
        // Ëá™Âä®Ëé∑ÂèñÂ∫îÁî®ÂàóË°®
        refreshApps();
    } else {
        // Ê∏ÖÁ©∫Â∫îÁî®ÂàóË°®
        const packageSelect = document.getElementById('packageSelect');
        packageSelect.innerHTML = '<option value="">ËØ∑ÂÖàÈÄâÊã©ËÆæÂ§á</option>';
        allApps = []; // Ê∏ÖÁ©∫Â∫îÁî®ÂàóË°®
    }
}

// Âà∑Êñ∞Â∫îÁî®ÂàóË°®
function refreshApps() {
    const deviceId = document.getElementById('deviceSelect').value;
    if (!deviceId) {
        showStatus('ËØ∑ÂÖàÈÄâÊã©ËÆæÂ§á', 'error');
        return;
    }
    
    showStatus('Ê≠£Âú®Ëé∑ÂèñÂ∫îÁî®ÂàóË°®...', 'info');
    socket.emit('get_apps', { device_id: deviceId });
}

// ÊêúÁ¥¢Â∫îÁî®ÂäüËÉΩ
function filterApps() {
    const searchInput = document.getElementById('appSearch');
    const packageSelect = document.getElementById('packageSelect');
    
    if (!searchInput || !packageSelect) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    // Ê∏ÖÁ©∫ÂΩìÂâçÈÄâÈ°π
    packageSelect.innerHTML = '';
    
    // Â¶ÇÊûúÊêúÁ¥¢Êù°‰ª∂‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâÂ∫îÁî®
    const filteredApps = searchTerm === '' 
        ? allApps 
        : allApps.filter(app => {
            const appName = (app.app_name || '').toLowerCase();
            const packageName = (app.package_name || '').toLowerCase();
            return appName.includes(searchTerm) || packageName.includes(searchTerm);
        });
    
    // ÊòæÁ§∫ËøáÊª§ÂêéÁöÑÂ∫îÁî®
    if (filteredApps.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = searchTerm === '' ? 'ËØ∑ÂÖàÈÄâÊã©ËÆæÂ§á' : 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂ∫îÁî®';
        packageSelect.appendChild(option);
    } else {
        filteredApps.forEach(app => {
            const option = document.createElement('option');
            option.value = app.package_name;
            option.textContent = `${app.app_name} (${app.package_name})`;
            packageSelect.appendChild(option);
        });
    }
}

// Êõ¥Êñ∞ÊÄßËÉΩÁªüËÆ°
function updatePerformanceStats(cpu, memory, fps, threads, diskReads, diskWrites) {
    // Êõ¥Êñ∞CPUÁªüËÆ°
    performanceStats.cpu.current = cpu;
    performanceStats.cpu.sum += cpu;
    performanceStats.cpu.count++;
    performanceStats.cpu.avg = performanceStats.cpu.sum / performanceStats.cpu.count;
    performanceStats.cpu.max = Math.max(performanceStats.cpu.max, cpu);
    
    // Êõ¥Êñ∞ÂÜÖÂ≠òÁªüËÆ°
    performanceStats.memory.current = memory;
    performanceStats.memory.sum += memory;
    performanceStats.memory.count++;
    performanceStats.memory.avg = performanceStats.memory.sum / performanceStats.memory.count;
    performanceStats.memory.max = Math.max(performanceStats.memory.max, memory);
    
    // Êõ¥Êñ∞FPSÁªüËÆ°
    if (fps > 0) {
        performanceStats.fps.current = fps;
        performanceStats.fps.sum += fps;
        performanceStats.fps.count++;
        performanceStats.fps.avg = performanceStats.fps.sum / performanceStats.fps.count;
        performanceStats.fps.min = Math.min(performanceStats.fps.min, fps);
    }
    
    // Êõ¥Êñ∞Á∫øÁ®ãÁªüËÆ°
    performanceStats.threads.current = threads;
    performanceStats.threads.sum += threads;
    performanceStats.threads.count++;
    performanceStats.threads.avg = performanceStats.threads.sum / performanceStats.threads.count;
    performanceStats.threads.max = Math.max(performanceStats.threads.max, threads);
    
    // Êõ¥Êñ∞Á£ÅÁõòËØªÂÜôÁªüËÆ°
    if (typeof diskReads === 'number') {
        performanceStats.disk_reads.current = diskReads;
        performanceStats.disk_reads.sum += diskReads;
        performanceStats.disk_reads.count++;
        performanceStats.disk_reads.avg = performanceStats.disk_reads.sum / performanceStats.disk_reads.count;
        performanceStats.disk_reads.max = Math.max(performanceStats.disk_reads.max, diskReads);
    }
    
    if (typeof diskWrites === 'number') {
        performanceStats.disk_writes.current = diskWrites;
        performanceStats.disk_writes.sum += diskWrites;
        performanceStats.disk_writes.count++;
        performanceStats.disk_writes.avg = performanceStats.disk_writes.sum / performanceStats.disk_writes.count;
        performanceStats.disk_writes.max = Math.max(performanceStats.disk_writes.max, diskWrites);
    }
    
    updateStatisticsDisplay();
}

// Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
function updateStatisticsDisplay() {
    document.getElementById('statCpuCurrent').textContent = `${performanceStats.cpu.current.toFixed(1)}%`;
    document.getElementById('statCpuAvg').textContent = `${performanceStats.cpu.avg.toFixed(1)}%`;
    document.getElementById('statCpuMax').textContent = `${performanceStats.cpu.max.toFixed(1)}%`;
    
    document.getElementById('statMemoryCurrent').textContent = `${performanceStats.memory.current.toFixed(1)}MB`;
    document.getElementById('statMemoryAvg').textContent = `${performanceStats.memory.avg.toFixed(1)}MB`;
    document.getElementById('statMemoryMax').textContent = `${performanceStats.memory.max.toFixed(1)}MB`;
    
    if (performanceStats.fps.count > 0) {
        document.getElementById('statFpsCurrent').textContent = `${performanceStats.fps.current}FPS`;
        document.getElementById('statFpsAvg').textContent = `${performanceStats.fps.avg.toFixed(1)}FPS`;
        document.getElementById('statFpsMin').textContent = `${performanceStats.fps.min === Infinity ? 0 : performanceStats.fps.min}FPS`;
    }
    
    document.getElementById('statThreadsCurrent').textContent = performanceStats.threads.current;
    document.getElementById('statThreadsAvg').textContent = performanceStats.threads.avg.toFixed(1);
    document.getElementById('statThreadsMax').textContent = performanceStats.threads.max;
    
    // Êõ¥Êñ∞Á£ÅÁõòËØªÂèñÁªüËÆ°ÊòæÁ§∫
    if (performanceStats.disk_reads.count > 0) {
        document.getElementById('statDiskReadsCurrent').textContent = `${performanceStats.disk_reads.current.toFixed(2)}MB`;
        document.getElementById('statDiskReadsAvg').textContent = `${performanceStats.disk_reads.avg.toFixed(2)}MB`;
        document.getElementById('statDiskReadsMax').textContent = `${performanceStats.disk_reads.max.toFixed(2)}MB`;
    }
    
    // Êõ¥Êñ∞Á£ÅÁõòÂÜôÂÖ•ÁªüËÆ°ÊòæÁ§∫
    if (performanceStats.disk_writes.count > 0) {
        document.getElementById('statDiskWritesCurrent').textContent = `${performanceStats.disk_writes.current.toFixed(2)}MB`;
        document.getElementById('statDiskWritesAvg').textContent = `${performanceStats.disk_writes.avg.toFixed(2)}MB`;
        document.getElementById('statDiskWritesMax').textContent = `${performanceStats.disk_writes.max.toFixed(2)}MB`;
    }
}

// Socket.IO‰∫ã‰ª∂ÁõëÂê¨Âô®
socket.on('devices_list', function(data) {
    const deviceSelect = document.getElementById('deviceSelect');
    deviceSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ËÆæÂ§á</option>';
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
    if (data.error) {
        showStatus(data.error, 'error');
        return;
    }
    
    // Á°Æ‰øùdevicesÊòØÊï∞ÁªÑ
    const devices = data.devices || [];
    
    devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = `${device.name} (${device.brand} - Android ${device.version})`;
        deviceSelect.appendChild(option);
    });
    
    if (devices.length > 0) {
        showStatus(`ÂèëÁé∞ ${devices.length} ‰∏™AndroidËÆæÂ§á`, 'success');
    } else {
        showStatus('Êú™ÂèëÁé∞AndroidËÆæÂ§áÔºåËØ∑Ê£ÄÊü•ËÆæÂ§áËøûÊé•ÂíåADBÁä∂ÊÄÅ', 'error');
    }
});

socket.on('apps_list', function(data) {
    const packageSelect = document.getElementById('packageSelect');
    const appSearch = document.getElementById('appSearch');
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
    if (data.error) {
        showStatus(data.error, 'error');
        packageSelect.innerHTML = '<option value="">Ëé∑ÂèñÂ∫îÁî®ÂàóË°®Â§±Ë¥•</option>';
        allApps = [];
        return;
    }
    
    // Á°Æ‰øù appsÊòØÊï∞ÁªÑ
    const apps = data.apps || [];
    
    // ‰øùÂ≠òÂÆåÊï¥Â∫îÁî®ÂàóË°®Áî®‰∫éÊêúÁ¥¢
    allApps = apps;
    
    // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
    if (appSearch) {
        appSearch.value = '';
    }
    
    // ÊòæÁ§∫ÊâÄÊúâÂ∫îÁî®
    packageSelect.innerHTML = '';
    
    if (apps.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Êú™ÂèëÁé∞Â∫îÁî®';
        packageSelect.appendChild(option);
        showStatus('Êú™ÂèëÁé∞Â∫îÁî®ÔºåËØ∑Ê£ÄÊü•ËÆæÂ§áÁä∂ÊÄÅ', 'error');
    } else {
        apps.forEach(app => {
            const option = document.createElement('option');
            option.value = app.package_name;
            // üîí ÊòæÁ§∫Ê†ºÂºèÔºöÂ∫îÁî®ÂêçÁß∞(ÂåÖÂêç)
            option.textContent = `${app.app_name} (${app.package_name})`;
            packageSelect.appendChild(option);
        });
        showStatus(`ÂèëÁé∞ ${apps.length} ‰∏™Â∫îÁî®ÔºåÂèØ‰ΩøÁî®ÊêúÁ¥¢Ê°ÜËøáÊª§`, 'success');
    }
});

socket.on('status', function(data) {
    showStatus(data.message, data.type);
    
    if (data.type === 'success' && data.message.includes('ÂºÄÂßãÁõëÊéß')) {
        isMonitoring = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
    } else if (data.type === 'info' && data.message.includes('Â∑≤ÂÅúÊ≠¢')) {
        isMonitoring = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
    }
});

socket.on('performance_data', function(data) {
    if (!isMonitoring) return;
    
    // ËÆ°ÁÆóCPUÂç†Áî®‰ø°ÊÅØ
    const cpuCores = data.cpu_cores || 8; // CPUÊ†∏ÂøÉÊï∞
    const appCpuRaw = data.cpu; // Â∫îÁî®CPUÔºàÁõ∏ÂØπÂçïÊ†∏ÔºåÂèØËÉΩË∂ÖËøá100%Ôºâ
    const systemCpu = data.system_cpu; // Êï¥Êú∫CPU‰ΩøÁî®Áéá
    
    // ËÆ°ÁÆóÂ∫îÁî®Âç†Êï¥Êú∫ÁöÑÁôæÂàÜÊØîÔºöappCpuRaw / cpuCores
    const appCpuPercent = (appCpuRaw / cpuCores).toFixed(1);
    
    // Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçÂÄºÊòæÁ§∫
    document.getElementById('currentCpu').textContent = `${appCpuRaw.toFixed(1)}%`;
    document.getElementById('cpuPercentOfTotal').textContent = `${appCpuPercent}%`;
    document.getElementById('cpuCores').textContent = `${cpuCores}Ê†∏`;
    document.getElementById('currentSystemCpu').textContent = `${systemCpu.toFixed(1)}%`;
    document.getElementById('cpuCoreInfo').textContent = `${cpuCores}Ê†∏ÂøÉ`;
    document.getElementById('currentMemory').textContent = `${data.memory.toFixed(1)}MB`;
    document.getElementById('systemMemInfo').textContent = `Á≥ªÁªü: ${data.system_memory_used.toFixed(0)}/${data.system_memory_total.toFixed(0)}MB`;
    document.getElementById('currentThreads').textContent = data.threads;
    document.getElementById('currentFps').textContent = `${data.fps}FPS`;
    
    // Êõ¥Êñ∞Á£ÅÁõòËØªÂÜôÂΩìÂâçÂÄºÊòæÁ§∫
    if (data.disk_reads !== undefined && typeof data.disk_reads === 'number') {
        document.getElementById('currentDiskReads').textContent = `${data.disk_reads.toFixed(1)}MB`;
    }
    if (data.disk_writes !== undefined && typeof data.disk_writes === 'number') {
        document.getElementById('currentDiskWrites').textContent = `${data.disk_writes.toFixed(1)}MB`;
    }
    
    // Ê∑ªÂä†Êï∞ÊçÆÂà∞ÂõæË°®
    addDataToChart(cpuChart, data.time, data.cpu);
    addDataToChart(memoryChart, data.time, data.memory);
    addDataToChart(threadsChart, data.time, data.threads);
    addDataToChart(fpsChart, data.time, data.fps);
    
    // Ê∑ªÂä†Á£ÅÁõòËØªÂÜôÊï∞ÊçÆÂà∞ÂõæË°®
    if (data.disk_reads !== undefined && typeof data.disk_reads === 'number') {
        addDataToChart(diskReadsChart, data.time, data.disk_reads);
    }
    if (data.disk_writes !== undefined && typeof data.disk_writes === 'number') {
        addDataToChart(diskWritesChart, data.time, data.disk_writes);
    }
    
    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    if (!window.statsUpdatePending) {
        window.statsUpdatePending = true;
        setTimeout(() => {
            const diskReads = (typeof data.disk_reads === 'number') ? data.disk_reads : 0;
            const diskWrites = (typeof data.disk_writes === 'number') ? data.disk_writes : 0;
            updatePerformanceStats(data.cpu, data.memory, data.fps || 0, data.threads, diskReads, diskWrites);
            window.statsUpdatePending = false;
        }, 500);
    }
});

socket.on('connect', function() {
    console.log('Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
});

socket.on('disconnect', function() {
    console.log('‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
    if (isMonitoring) {
        showStatus('‰∏éÊúçÂä°Âô®ËøûÊé•Êñ≠ÂºÄ', 'error');
    }
});

// Â§ÑÁêÜÁ∫øÁ®ãËØ¶ÊÉÖÊï∞ÊçÆ
socket.on('thread_details', function(data) {
    if (!isMonitoring) return;
    
    const threads = data.threads || [];
    updateThreadDistribution(threads);
});

// Êõ¥Êñ∞Á∫øÁ®ãÂàÜÂ∏ÉÊòæÁ§∫
function updateThreadDistribution(threads) {
    // ÁªüËÆ°Á∫øÁ®ãÁä∂ÊÄÅ
    const stats = {
        total: threads.length,
        running: 0,
        sleeping: 0,
        other: 0
    };
    
    // ÊåâÁ±ªÂûãÁªüËÆ°Á∫øÁ®ãÊï∞Èáè
    const typeStats = {};
    
    threads.forEach(thread => {
        // ÁªüËÆ°Áä∂ÊÄÅ
        switch (thread.state) {
            case 'R':
                stats.running++;
                break;
            case 'S':
                stats.sleeping++;
                break;
            default:
                stats.other++;
                break;
        }
        
        // ÁªüËÆ°Á±ªÂûã
        if (typeStats[thread.type]) {
            typeStats[thread.type]++;
        } else {
            typeStats[thread.type] = 1;
        }
    });
    
    // Êõ¥Êñ∞Áä∂ÊÄÅÁªüËÆ°ÊòæÁ§∫
    document.getElementById('totalThreads').textContent = stats.total;
    document.getElementById('runningThreads').textContent = stats.running;
    document.getElementById('sleepingThreads').textContent = stats.sleeping;
    document.getElementById('otherThreads').textContent = stats.other;
    
    // ÊòæÁ§∫Á∫øÁ®ãÁ±ªÂûãÁªüËÆ°ÔºàÂèØÁÇπÂáªÂ±ïÂºÄÔºâ
    createThreadTypeStats(typeStats, stats.total, threads);
    
    // Êõ¥Êñ∞Á∫øÁ®ãÂàóË°®ÔºàÈªòËÆ§ÊòæÁ§∫ÊâÄÊúâÁ∫øÁ®ãÔºâ
    updateThreadList(threads);
}

// ÂàõÂª∫Á∫øÁ®ãÁ±ªÂûãÁªüËÆ°
function createThreadTypeStats(typeStats, totalCount, allThreads) {
    const threadStatsContainer = document.querySelector('.thread-summary');
    
    // Ëé∑ÂèñÊàñÂàõÂª∫Á∫øÁ®ãÁ±ªÂûãÁªüËÆ°ÂÆπÂô®
    let typeStatsContainer = document.getElementById('threadTypeStats');
    if (!typeStatsContainer) {
        typeStatsContainer = document.createElement('div');
        typeStatsContainer.id = 'threadTypeStats';
        typeStatsContainer.style.cssText = `
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e5e7;
        `;
        
        const title = document.createElement('h4');
        title.textContent = 'üìä Á∫øÁ®ãÁ±ªÂûãÁªüËÆ° (ÁÇπÂáªÂ±ïÂºÄ)';
        title.style.cssText = `
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #1d1d1f;
            font-weight: 600;
        `;
        typeStatsContainer.appendChild(title);
        
        // ÊèíÂÖ•Âà∞Áä∂ÊÄÅÁªüËÆ°‰πãÂêé
        threadStatsContainer.insertAdjacentElement('afterend', typeStatsContainer);
    }
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÁªüËÆ°ÂÜÖÂÆπÔºà‰øùÁïôÊ†áÈ¢òÔºâ
    const existingStats = typeStatsContainer.querySelectorAll('.type-stat-item');
    existingStats.forEach(item => item.remove());
    
    // ÊåâÊï∞ÈáèÊéíÂ∫èÁ∫øÁ®ãÁ±ªÂûã
    const sortedTypes = Object.entries(typeStats).sort((a, b) => b[1] - a[1]);
    
    // ÂàõÂª∫Á±ªÂûãÁªüËÆ°ÁΩëÊ†º
    const statsGrid = document.createElement('div');
    statsGrid.style.cssText = `
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    `;
    
    sortedTypes.forEach(([type, count]) => {
        const percentage = ((count / totalCount) * 100).toFixed(1);
        
        const typeCard = document.createElement('div');
        typeCard.className = 'type-stat-item';
        typeCard.style.cssText = `
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e5e5e7;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        `;
        
        typeCard.innerHTML = `
            <div style="font-size: 11px; color: #86868b; margin-bottom: 4px;">${type}</div>
            <div style="font-size: 16px; font-weight: 600; color: #007aff;">${count}‰∏™</div>
            <div style="font-size: 10px; color: #86868b;">(${percentage}%)</div>
        `;
        
        // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
        typeCard.addEventListener('mouseenter', () => {
            typeCard.style.transform = 'translateY(-2px)';
            typeCard.style.boxShadow = '0 4px 12px rgba(0, 122, 255, 0.15)';
            typeCard.style.borderColor = '#007aff';
        });
        
        typeCard.addEventListener('mouseleave', () => {
            typeCard.style.transform = 'translateY(0)';
            typeCard.style.boxShadow = 'none';
            typeCard.style.borderColor = '#e5e5e7';
        });
        
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ËøáÊª§ÊòæÁ§∫ËØ•Á±ªÂûãÁöÑÁ∫øÁ®ã
        typeCard.addEventListener('click', () => {
            filterThreadsByType(allThreads, type, typeCard);
        });
        
        statsGrid.appendChild(typeCard);
    });
    
    typeStatsContainer.appendChild(statsGrid);
}

// ÊåâÁ±ªÂûãËøáÊª§Á∫øÁ®ãÂπ∂È´ò‰∫ÆÊòæÁ§∫
function filterThreadsByType(allThreads, selectedType, clickedCard) {
    // ÈáçÁΩÆÊâÄÊúâÂç°ÁâáÊ†∑Âºè
    document.querySelectorAll('.type-stat-item').forEach(card => {
        card.style.backgroundColor = 'white';
        card.style.color = '';
    });
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈÄâ‰∏≠‰∫ÜËøô‰∏™Á±ªÂûãÔºàÂàáÊç¢ÊòæÁ§∫Ôºâ
    const isCurrentlySelected = clickedCard.style.backgroundColor === 'rgb(0, 122, 255)';
    
    if (isCurrentlySelected) {
        // Â¶ÇÊûúÂ∑≤ÈÄâ‰∏≠ÔºåÂàôÊòæÁ§∫ÊâÄÊúâÁ∫øÁ®ã
        updateThreadList(allThreads);
        updateThreadListTitle('ÊâÄÊúâÁ∫øÁ®ã');
    } else {
        // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÂç°Áâá
        clickedCard.style.backgroundColor = '#007aff';
        clickedCard.style.color = 'white';
        
        // ËøáÊª§ÊòæÁ§∫ÈÄâ‰∏≠Á±ªÂûãÁöÑÁ∫øÁ®ã
        const filteredThreads = allThreads.filter(thread => thread.type === selectedType);
        updateThreadList(filteredThreads);
        updateThreadListTitle(`${selectedType} Á±ªÂûãÁ∫øÁ®ã (${filteredThreads.length}‰∏™)`);
    }
}

// Êõ¥Êñ∞Á∫øÁ®ãÂàóË°®Ê†áÈ¢ò
function updateThreadListTitle(title) {
    let titleElement = document.getElementById('threadListTitle');
    if (!titleElement) {
        titleElement = document.createElement('h4');
        titleElement.id = 'threadListTitle';
        titleElement.style.cssText = `
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #1d1d1f;
            font-weight: 600;
            padding: 0 15px;
        `;
        
        const threadList = document.querySelector('.thread-list');
        threadList.insertBefore(titleElement, threadList.firstChild);
    }
    titleElement.textContent = title;
}

// Êõ¥Êñ∞Á∫øÁ®ãÂàóË°®ÊòæÁ§∫
function updateThreadList(threads) {
    const threadListContent = document.getElementById('threadListContent');
    
    if (threads.length === 0) {
        threadListContent.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #86868b; font-style: italic;">
                ÊöÇÊó†Á∫øÁ®ãÊï∞ÊçÆ...
            </div>
        `;
        return;
    }
    
    // ÊåâÁä∂ÊÄÅÂíåÁ±ªÂûãÂØπÁ∫øÁ®ãËøõË°åÊéíÂ∫è
    const sortedThreads = threads.sort((a, b) => {
        // 1. È¶ñÂÖàÊåâÁä∂ÊÄÅÊéíÂ∫èÔºöR(ËøêË°å‰∏≠) > S(Áù°Áú†‰∏≠) > ÂÖ∂‰ªñ
        const stateOrder = { 'R': 0, 'S': 1 };
        const aStateOrder = stateOrder[a.state] !== undefined ? stateOrder[a.state] : 2;
        const bStateOrder = stateOrder[b.state] !== undefined ? stateOrder[b.state] : 2;
        
        if (aStateOrder !== bStateOrder) {
            return aStateOrder - bStateOrder;
        }
        
        // 2. Áõ∏ÂêåÁä∂ÊÄÅ‰∏ãÊåâÁ±ªÂûãÊéíÂ∫è
        if (a.type !== b.type) {
            return a.type.localeCompare(b.type);
        }
        
        // 3. Áõ∏ÂêåÁ±ªÂûã‰∏ãÊåâTIDÊéíÂ∫è
        return parseInt(a.tid) - parseInt(b.tid);
    });
    
    // ÁîüÊàêÁ∫øÁ®ãÂàóË°®HTML
    let html = '';
    let currentState = null;
    let currentType = null;
    
    sortedThreads.forEach(thread => {
        // Â¶ÇÊûúÊòØÊñ∞Áä∂ÊÄÅÔºåÊ∑ªÂä†Áä∂ÊÄÅÂàÜÁªÑÊ†áÈ¢ò
        if (thread.state !== currentState) {
            currentState = thread.state;
            const stateText = getStateText(thread.state);
            const stateColor = thread.state === 'R' ? '#ff3b30' : thread.state === 'S' ? '#34c759' : '#ff9500';
            html += `<div style="padding: 8px 15px; background: ${stateColor}; color: white; font-size: 12px; font-weight: 600; position: sticky; top: 0; z-index: 10;">`;
            html += `üî¥ ${stateText} (${sortedThreads.filter(t => t.state === thread.state).length}‰∏™)`;
            html += `</div>`;
            currentType = null; // ÈáçÁΩÆÁ±ªÂûãÂàÜÁªÑ
        }
        
        // Â¶ÇÊûúÊòØÊñ∞Á±ªÂûãÔºåÊ∑ªÂä†Á±ªÂûãÂ≠êÂàÜÁªÑ
        if (thread.type !== currentType) {
            currentType = thread.type;
            const typeCount = sortedThreads.filter(t => t.state === thread.state && t.type === thread.type).length;
            html += `<div style="padding: 5px 15px; background: #f8f9fa; border-left: 3px solid #007aff; font-size: 11px; font-weight: 600; color: #666;">`;
            html += `üìÇ ${thread.type} (${typeCount}‰∏™)`;
            html += `</div>`;
        }
        
        html += `
            <div class="thread-item">
                <div class="thread-tid">${thread.tid}</div>
                <div class="thread-name" title="${thread.name}">${thread.name}</div>
                <div class="thread-state ${thread.state}">${getStateText(thread.state)}</div>
                <div>${thread.type}</div>
            </div>
        `;
    });
    
    threadListContent.innerHTML = html;
}

// Ëé∑ÂèñÁ∫øÁ®ãÁä∂ÊÄÅÊñáÊú¨
function getStateText(state) {
    switch (state) {
        case 'R': return 'ËøêË°å‰∏≠';
        case 'S': return 'Áù°Áú†‰∏≠';
        case 'D': return '‰∏çÂèØ‰∏≠Êñ≠';
        case 'T': return 'ÂÅúÊ≠¢';
        case 'Z': return 'ÂÉµÂ∞∏';
        default: return state || 'Êú™Áü•';
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('AndroidÊÄßËÉΩÁõëÊéßÂèØËßÜÂåñÁïåÈù¢Â∑≤Âä†ËΩΩ');
    
    setTimeout(() => {
        initCharts();
        initDragAndDrop();
        ensureStatisticsPanelPosition(); // üîí ÂÖ≥ÈîÆ‰øÆÊîπ4ÔºöÁ°Æ‰øùÁªüËÆ°Èù¢Êùø‰ΩçÁΩÆ
        restorePanelOrder();
    }, 100);
    
    // Ëá™Âä®Âà∑Êñ∞ËÆæÂ§áÂàóË°®
    refreshDevices();
});

// üîí Á°Æ‰øùÁªüËÆ°Èù¢ÊùøÂú®ÊâÄÊúâÂõæË°®ÂÆπÂô®‰∏äÊñπ
function ensureStatisticsPanelPosition() {
    const container = document.querySelector('.container');
    const statisticsPanel = document.getElementById('statisticsPanel');
    const firstChartContainer = document.getElementById('cpuChart-container');
    
    if (container && statisticsPanel && firstChartContainer) {
        // Â∞ÜÁªüËÆ°Èù¢ÊùøÁßªÂä®Âà∞Á¨¨‰∏Ä‰∏™ÂõæË°®ÂÆπÂô®‰πãÂâç
        container.insertBefore(statisticsPanel, firstChartContainer);
        console.log('‚úÖ ÁªüËÆ°Èù¢ÊùøÂ∑≤ÊîæÁΩÆÂú®ÂõæË°®‰∏äÊñπ');
    } else {
        console.warn('‚ö†Ô∏è ÁªüËÆ°Èù¢Êùø‰ΩçÁΩÆË∞ÉÊï¥Â§±Ë¥•Ôºö', {
            container: !!container,
            statisticsPanel: !!statisticsPanel,
            firstChartContainer: !!firstChartContainer
        });
    }
}